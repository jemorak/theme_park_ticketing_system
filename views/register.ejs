<!DOCTYPE html>
<h1>Register a new account!</h1>
<form id="register-form" class="register-user-form" method="post">
	<fieldset class="register-user-form-area">
		<label for="email">Email Address</label>
		<input id="email" autocomplete="email" name="email" required type="text"></input>
	</fieldset>
	<fieldset class="register-user-form-area">
		<label for="password">Password</label>
		<input id="password" autocomplete="current-password" minlength="6" name="password" required
			type="password"></input>
		<p>Password must be at least 6 characters</p>
	</fieldset>
	<input id="register" type="submit" value="Register"></input>
</form>

<script type="module">
	'use strict'

	import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
	import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";


	const domEmail = document.getElementById("email");
	const domError = document.getElementById("error");
	const domForm = document.getElementById("register-form");
	const domPassword = document.getElementById("password");
	const domSubmit = document.getElementById("register");

	const firebaseCfg = {
		apiKey: process.env.FIREBASE_API_KEY,
    	authDomain: process.env.FIREBASE_AUTH_DOMAIN,
    	projectId: process.env.FIREBASE_PROJECT_ID,
    	storageBucket: process.env.FIREBASE_STORAGE_BUCKET,
    	messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID,
    	appId: process.env.FIREBASE_APP_ID,
    	measurementId: process.env.FIREBASE_MEASUREMENT_ID
	};

	const firebaseApp = initializeApp(firebaseCfg);
	const firebaseAuth = getAuth();

	domForm.addEventListener("change", () => {
		domSubmit.disabled = !domForm.checkValidity();
	});
	domForm.addEventListener("submit", (event) => {
		event.preventDefault();
		register();
	});


	function register() {
		createUserWithEmailAndPassword(firebaseAuth, domEmail.value, domPassword.value)
			.then(async (userCredential) => {
				const idTokenCred = await userCredential.user.getIdToken();
				const jsonBody = JSON.stringify({ idToken: idTokenCred });


				fetch("/users/session-register",
					{
						method: "POST",
						headers:
						{
							"Content-Type": "application/json"
						},
						body: jsonBody
					})
					.then(() => {
						window.location.assign("/users/logged-in-rides");
					})
					.catch((err) => {
						console.error('Error:', error.message);
					});

				domError.innerHTML = "";
			})
			.catch((error) => {
				let errorMsg;
				switch (error.code) {
					case "auth/invalid-email":
						errorMsg = "Invalid email address";
						break;	
					case "auth/email-already-in-use":
						errorMsg = "Email address is already in use";
						break;
					case "auth/weak-password":
						errorMsg = "Password is too weak";
						break;					
					default:
						errorMsg = "An error occurred. Please try again later";
						break;
				}
				domError.innerHTML = errorMsg;
			});
	}


</script>